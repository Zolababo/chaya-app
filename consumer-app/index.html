<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAYA 메뉴판</title>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .category-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .category-scroll-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const SUPABASE_URL = 'https://kzxdrwdfqhwpkqbswutr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGRyd2RmcWh3cGtxYnN3dXRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDQyMzcsImV4cCI6MjA3MjIyMDIzN30.pAjU3qCA7tkAoORn9-04HBNlt0N3u25nx0Y_uy0F3jc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const Message = ({ message, isVisible }) => {
            return (
                <div className={`fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-sm px-4 py-2 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 z-50 ${isVisible ? 'opacity-100' : ''}`}>
                    {message}
                </div>
            );
        };

        const App = () => {
            const [menus, setMenus] = useState([]);
            const [categories, setCategories] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [orderItems, setOrderItems] = useState({});
            const [isItemModalOpen, setIsItemModalOpen] = useState(false);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [selectedItem, setSelectedItem] = useState(null);
            const [itemQuantity, setItemQuantity] = useState(0);
            const [itemNotes, setItemNotes] = useState('');
            const [message, setMessage] = useState('');
            const [isMessageVisible, setIsMessageVisible] = useState(false);
            const [selectedCategory, setSelectedCategory] = useState('전체');

            const categorySummaryColors = {
                '음식': 'bg-pink-300',
                '음료': 'bg-purple-300',
                '샐러드': 'bg-green-300',
                '커피': 'bg-orange-300',
                '디저트': 'bg-sky-300',
                '기타': 'bg-gray-300',
            };

            const showMessage = (msg) => {
                setMessage(msg);
                setIsMessageVisible(true);
                setTimeout(() => {
                    setIsMessageVisible(false);
                }, 3000);
            };

            const fetchMenus = async () => {
                setIsLoading(true);
                const { data: menuItems, error } = await supabase
                    .from('ChayaMenus')
                    .select('*')
                    .order('category', { ascending: true })
                    .order('name', { ascending: true });

                if (error) {
                    console.error("데이터 불러오기 오류:", error);
                    showMessage("메뉴 데이터를 불러오는 데 실패했습니다.");
                } else {
                    setMenus(menuItems);
                    const uniqueCategories = [...new Set(menuItems.map(menu => menu.category))];
                    const sortedCategories = uniqueCategories.sort((a, b) => {
                        if (a === '음식') return -1;
                        if (b === '음식') return 1;
                        return a.localeCompare(b);
                    });
                    setCategories(['전체', ...sortedCategories]);
                }
                setIsLoading(false);
            };

            useEffect(() => {
                fetchMenus();
            }, []);

            const openItemModal = (menu) => {
                setSelectedItem(menu);
                setItemQuantity(orderItems[menu.id]?.quantity || 0);
                setItemNotes(orderItems[menu.id]?.notes || '');
                setIsItemModalOpen(true);
            };

            const closeItemModal = () => {
                setIsItemModalOpen(false);
                setSelectedItem(null);
            };

            const handleUpdateItem = (menu, quantity) => {
                setOrderItems(prev => {
                    const newOrder = { ...prev };
                    if (quantity <= 0) {
                        delete newOrder[menu.id];
                        showMessage(`${menu.name}이(가) 삭제되었습니다.`);
                    } else {
                        const existingItem = newOrder[menu.id] || { ...menu, quantity: 0, notes: '' };
                        newOrder[menu.id] = {
                            ...existingItem,
                            quantity: quantity,
                            category: menu.category,
                        };
                        showMessage(`${menu.name} 수량이 ${quantity}개로 변경되었습니다.`);
                    }
                    return newOrder;
                });
            };

            const handleUpdateItemInModal = () => {
                if (itemQuantity > 0) {
                    const newItem = {
                        ...selectedItem,
                        quantity: itemQuantity,
                        notes: itemNotes,
                        category: selectedItem.category,
                    };
                    setOrderItems(prev => ({
                        ...prev,
                        [selectedItem.id]: newItem,
                    }));
                } else {
                    setOrderItems(prev => {
                        const newOrder = { ...prev };
                        delete newOrder[selectedItem.id];
                        return newOrder;
                    });
                }
                closeItemModal();
                showMessage(`${selectedItem.name} ${itemQuantity > 0 ? '이(가) 수정되었습니다.' : '이(가) 삭제되었습니다.'}`);
            };
            
            const handlePlaceOrder = async () => {
                const orderedItems = Object.values(orderItems).map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    notes: item.notes,
                }));

                if (orderedItems.length === 0) {
                    showMessage("주문할 메뉴를 선택해주세요.");
                    return;
                }
                
                showMessage("주문이 접수되고 있습니다...");

                const total_price = orderedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                const { error } = await supabase.from('orders').insert([{
                    items: orderedItems,
                    total_price: total_price
                }]);

                if (error) {
                    console.error("주문 실패:", error);
                    showMessage("주문 전송에 실패했습니다. 다시 시도해주세요.");
                } else {
                    showMessage("주문이 성공적으로 접수되었습니다!");
                    setOrderItems({});
                    setIsCartOpen(false);
                }
            };
            
            const totalItems = useMemo(() => {
                return Object.values(orderItems).reduce((sum, item) => sum + item.quantity, 0);
            }, [orderItems]);

            const totalPrice = useMemo(() => {
                return Object.values(orderItems).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            }, [orderItems]);

            const filteredCategories = useMemo(() => {
                if (selectedCategory === '전체') {
                    return categories.filter(c => c !== '전체');
                } else {
                    return [selectedCategory];
                }
            }, [categories, selectedCategory]);

            // UI 컴포넌트들
            const ItemDetailModal = () => (
                <div className="modal-overlay" onClick={closeItemModal}>
                    <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-lg mx-4 animate-fade-in-up" onClick={e => e.stopPropagation()}>
                        {selectedItem.imageUrl && <img src={selectedItem.imageUrl} alt={selectedItem.name} className="w-full h-48 object-cover rounded-2xl mb-4" />}
                        <h3 className="text-2xl font-bold text-gray-900 mb-2">{selectedItem.name}</h3>
                        <p className="text-gray-500 mb-4">{selectedItem.description}</p>
                        <p className="text-2xl font-bold text-indigo-600 mb-4">{selectedItem.price.toLocaleString()}원</p>
                        
                        <div className="mb-4">
                            <label htmlFor="itemNotes" className="block text-sm font-medium text-gray-700">추가 요청사항 (예: 덜 맵게 해주세요)</label>
                            <textarea id="itemNotes" value={itemNotes} onChange={e => setItemNotes(e.target.value)} rows="3" className="mt-1 block w-full border-gray-300 rounded-xl shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                        </div>
                        
                        <div className="flex items-center justify-between mb-6">
                            <span className="text-lg font-semibold">수량</span>
                            <div className="flex items-center space-x-4">
                                <button onClick={() => setItemQuantity(Math.max(0, itemQuantity - 1))} className="bg-gray-200 text-gray-800 p-2 rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg hover:bg-gray-300 transition">-</button>
                                <span className="text-xl font-bold w-6 text-center">{itemQuantity}</span>
                                <button onClick={() => setItemQuantity(itemQuantity + 1)} className="bg-indigo-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg hover:bg-indigo-700 transition">+</button>
                            </div>
                        </div>

                        <div className="flex justify-end space-x-4">
                            <button onClick={closeItemModal} className="bg-gray-300 text-gray-800 p-3 rounded-lg hover:bg-gray-400 transition">취소</button>
                            <button onClick={handleUpdateItemInModal} className="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition">
                                {itemQuantity > 0 ? `${itemQuantity}개 담기` : '삭제'}
                            </button>
                        </div>
                    </div>
                </div>
            );

            const CartModal = () => (
                <div className="modal-overlay" onClick={() => setIsCartOpen(false)}>
                    <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto animate-fade-in-up" onClick={e => e.stopPropagation()}>
                        <h3 className="text-2xl font-bold text-gray-900 mb-4">주문 확인</h3>
                        <div className="space-y-4 mb-6">
                            {Object.values(orderItems).length === 0 ? (
                                <p className="text-center text-gray-500">장바구니가 비어있습니다.</p>
                            ) : (
                                Object.values(orderItems).map(item => (
                                    <div key={item.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm">
                                        {item.imageUrl && <img src={item.imageUrl} alt={item.name} className="w-16 h-16 object-cover rounded-lg mr-4" />}
                                        <div className="flex-grow">
                                            <p className="font-semibold text-gray-800">{item.name}</p>
                                            <p className="text-sm text-gray-500">{item.price.toLocaleString()}원</p>
                                            {item.notes && <p className="text-xs text-gray-400 mt-1">요청: {item.notes}</p>}
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <button onClick={() => handleUpdateItem(item, item.quantity - 1)} className="bg-gray-200 text-gray-800 p-1 rounded-full w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-300 transition">-</button>
                                            <span className="text-lg font-bold w-6 text-center">{item.quantity}</span>
                                            <button onClick={() => handleUpdateItem(item, item.quantity + 1)} className="bg-gray-200 text-gray-800 p-1 rounded-full w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-300 transition">+</button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                        <div className="flex justify-between items-center text-xl font-bold text-gray-900 mb-6 border-t pt-4">
                            <span>총 합계</span>
                            <span>{totalPrice.toLocaleString()}원</span>
                        </div>
                        <div className="flex justify-end space-x-4">
                            <button onClick={() => setIsCartOpen(false)} className="bg-gray-300 text-gray-800 p-3 rounded-lg hover:bg-gray-400 transition">더 담으러 가기</button>
                            <button onClick={handlePlaceOrder} className="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition" disabled={totalItems === 0}>
                                {totalPrice.toLocaleString()}원 주문하기
                            </button>
                        </div>
                    </div>
                </div>
            );

            const MenuSection = ({ category, menus }) => (
                <div className="mb-8">
                    <h2 className="text-2xl font-bold text-gray-700 mb-4">{category}</h2>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        {menus.map(menu => {
                            const quantity = orderItems[menu.id]?.quantity || 0;
                            return (
                                <div key={menu.id} onClick={() => openItemModal(menu)} className={`rounded-3xl shadow-xl overflow-hidden flex flex-col cursor-pointer transition transform hover:scale-105 active:scale-95 duration-300 bg-white`}>
                                    {menu.imageUrl && <img src={menu.imageUrl} alt={menu.name} className="w-full h-32 object-cover" />}
                                    <div className="p-3 flex flex-col justify-between flex-grow">
                                        <div>
                                            <h3 className="text-md font-bold text-gray-800 truncate">{menu.name}</h3>
                                            <p className="text-sm text-gray-400 mt-1 truncate">{menu.description}</p>
                                        </div>
                                        <div className="flex items-center justify-between mt-2">
                                            <p className="text-md font-bold text-gray-600">{menu.price.toLocaleString()}원</p>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={(e) => { e.stopPropagation(); handleUpdateItem(menu, Math.max(0, quantity - 1)); }} className="bg-gray-200 text-gray-800 p-1 rounded-full w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-300 transition">-</button>
                                                <span className="text-lg font-bold w-6 text-center">{quantity}</span>
                                                <button onClick={(e) => { e.stopPropagation(); handleUpdateItem(menu, quantity + 1); }} className="bg-gray-200 text-gray-800 p-1 rounded-full w-7 h-7 flex items-center justify-center font-bold text-sm hover:bg-gray-300 transition">+</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            return (
                <div className="bg-gray-100 min-h-screen relative p-4 pb-20 sm:p-8 sm:pb-24">
                    <div className="container mx-auto max-w-5xl">
                        <header className="sticky top-0 bg-white z-20 py-4 mb-4 shadow-md rounded-b-xl">
                            <h1 className="text-3xl font-bold text-gray-800 text-center no-select">CHAYA</h1>
                        </header>

                        <div className="sticky top-[4.5rem] bg-white z-10 py-4 mb-4 category-scroll-container overflow-x-auto whitespace-nowrap border-b border-gray-300 shadow-sm rounded-xl">
                            {categories.map(category => (
                                <button
                                    key={category}
                                    onClick={() => setSelectedCategory(category)}
                                    className={`inline-block px-4 py-2 rounded-full font-semibold transition-colors duration-200 mr-2
                                        ${selectedCategory === category ? 'bg-purple-600 text-white' : 'text-gray-700 hover:bg-gray-300'}`}
                                >
                                    {category}
                                </button>
                            ))}
                        </div>
                        
                        {isLoading ? (
                            <p className="text-center text-gray-500 mt-20">메뉴를 불러오는 중...</p>
                        ) : (
                            <main>
                                {filteredCategories.map(category => (
                                    <MenuSection key={category} category={category} menus={menus.filter(menu => menu.category === category)} />
                                ))}
                            </main>
                        )}
                        
                        {totalItems > 0 && (
                            <footer className="fixed bottom-0 left-0 right-0 bg-white shadow-2xl p-4 sm:p-6 border-t border-gray-200 z-30">
                                <div className="container mx-auto max-w-5xl flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                    <div className="flex-grow overflow-x-auto whitespace-nowrap mb-2 sm:mb-0 pb-2">
                                        {Object.values(orderItems).map(item => (
                                            <span key={item.id} className={`inline-block ${categorySummaryColors[item.category] || 'bg-gray-300'} rounded-full px-3 py-1 text-sm font-semibold text-gray-800 mr-2`}>
                                                {item.name} {item.quantity}개
                                            </span>
                                        ))}
                                    </div>
                                    <div className="flex items-center justify-between sm:justify-end w-full sm:w-auto">
                                        <p className="text-lg font-bold text-indigo-600 sm:ml-4">{totalPrice.toLocaleString()}원</p>
                                        <button onClick={() => setIsCartOpen(true)} className="bg-indigo-600 text-white p-3 rounded-lg shadow-md hover:bg-indigo-700 transition ml-4">
                                            장바구니 확인
                                        </button>
                                    </div>
                                </div>
                            </footer>
                        )}
                    </div>
                    {isItemModalOpen && <ItemDetailModal />}
                    {isCartOpen && <CartModal />}
                    <Message message={message} isVisible={isMessageVisible} />
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
