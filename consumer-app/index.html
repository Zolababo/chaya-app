<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAYA 메뉴판</title>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .show {
            opacity: 1 !important;
        }
        .message-box {
            position: fixed;
            bottom: 4rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            transition: opacity 0.3s ease-out;
        }
        /* 장바구니 요약바 모바일 최적화 */
        .summary-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap; /* 줄바꿈 방지 */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://kzxdrwdfqhwpkqbswutr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6eGRyd2RmcWh3cGtxYnN3dXRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDQyMzcsImV4cCI6MjA3MjIyMDIzN30.pAjU3qCA7tkAoORn9-04HBNlt0N3u25nx0Y_uy0F3jc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const showMessage = (msg, setMessage, setIsMessageVisible) => {
            setMessage(msg);
            setIsMessageVisible(true);
            setTimeout(() => {
                setIsMessageVisible(false);
            }, 3000);
        };

        const App = () => {
            const [menus, setMenus] = useState([]);
            const [orderItems, setOrderItems] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isItemModalOpen, setIsItemModalOpen] = useState(false);
            const [selectedMenu, setSelectedMenu] = useState(null);
            const [isCartOpen, setIsCartOpen] = useState(false);
            const [message, setMessage] = useState('');
            const [isMessageVisible, setIsMessageVisible] = useState(false);

            useEffect(() => {
                const fetchMenus = async () => {
                    const { data, error } = await supabase
                        .from('ChayaMenus')
                        .select('*')
                        .order('category', { ascending: true })
                        .order('price', { ascending: true });
                    
                    if (error) {
                        console.error("Error fetching menus:", error);
                        showMessage("메뉴를 불러오는 데 실패했습니다.", setMessage, setIsMessageVisible);
                    } else {
                        const groupedMenus = data.reduce((acc, menu) => {
                            (acc[menu.category] = acc[menu.category] || []).push(menu);
                            return acc;
                        }, {});
                        setMenus(groupedMenus);
                    }
                    setIsLoading(false);
                };
                fetchMenus();
            }, []);

            const handleMenuItemClick = (menu) => {
                setSelectedMenu(menu);
                setIsItemModalOpen(true);
            };

            const addItemToOrder = (menu, quantity) => {
                setOrderItems(prevItems => {
                    const existingItem = prevItems.find(item => item.id === menu.id);
                    if (existingItem) {
                        return prevItems.map(item => 
                            item.id === menu.id ? { ...item, quantity: item.quantity + quantity } : item
                        );
                    } else {
                        return [...prevItems, { ...menu, quantity }];
                    }
                });
                setIsItemModalOpen(false);
                showMessage(`${menu.name} ${quantity}개 추가되었습니다.`, setMessage, setIsMessageVisible);
            };

            const updateItemQuantity = (id, quantity) => {
                if (quantity <= 0) {
                    setOrderItems(prevItems => prevItems.filter(item => item.id !== id));
                } else {
                    setOrderItems(prevItems => prevItems.map(item =>
                        item.id === id ? { ...item, quantity } : item
                    ));
                }
            };
            
            const placeOrder = async () => {
                if (orderItems.length === 0) {
                    showMessage('주문할 메뉴를 선택해주세요!', setMessage, setIsMessageVisible);
                    return;
                }

                const total_price = orderItems.reduce((acc, item) => acc + item.price * item.quantity, 0);
                
                const { data, error } = await supabase.from('orders').insert([
                    {
                        items: orderItems,
                        total_price: total_price
                    }
                ]).select();

                if (error) {
                    console.error("주문 실패:", error);
                    showMessage('주문에 실패했습니다. 다시 시도해 주세요.', setMessage, setIsMessageVisible);
                } else {
                    console.log("주문 성공:", data);
                    showMessage('주문이 성공적으로 접수되었습니다!', setMessage, setIsMessageVisible);
                    setOrderItems([]);
                    setIsCartOpen(false);
                }
            };

            const ItemDetailModal = () => (
                <div className="modal-overlay" onClick={() => setIsItemModalOpen(false)}>
                    <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-lg mx-4 animate-fade-in-up" onClick={e => e.stopPropagation()}>
                        <div className="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6">
                            {selectedMenu?.imageUrl && (
                                <img src={selectedMenu.imageUrl} alt={selectedMenu.name} className="w-32 h-32 object-cover rounded-xl shadow-md" />
                            )}
                            <div className="flex-1 text-center sm:text-left">
                                <h3 className="text-2xl font-bold text-gray-900">{selectedMenu.name}</h3>
                                <p className="text-lg text-indigo-600 font-semibold mt-1">{selectedMenu.price.toLocaleString()}원</p>
                                <p className="text-sm text-gray-500 mt-2">{selectedMenu.description}</p>
                            </div>
                        </div>
                        <div className="flex justify-end space-x-4 mt-6">
                            <button onClick={() => setIsItemModalOpen(false)} className="bg-gray-300 text-gray-800 p-3 rounded-lg hover:bg-gray-400 transition">취소</button>
                            <button onClick={() => addItemToOrder(selectedMenu, 1)} className="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition">장바구니 담기</button>
                        </div>
                    </div>
                </div>
            );

            const CartModal = () => {
                const totalItems = orderItems.reduce((acc, item) => acc + item.quantity, 0);
                const totalPrice = orderItems.reduce((acc, item) => acc + item.price * item.quantity, 0);

                return (
                    <div className="modal-overlay" onClick={() => setIsCartOpen(false)}>
                        <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-lg mx-4 animate-fade-in-up" onClick={e => e.stopPropagation()}>
                            <h3 className="text-2xl font-bold text-gray-900 mb-4">장바구니</h3>
                            {orderItems.length > 0 ? (
                                <div className="space-y-4 max-h-80 overflow-y-auto">
                                    {orderItems.map(item => (
                                        <div key={item.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-xl">
                                            <div className="flex-1">
                                                <p className="font-semibold text-gray-800">{item.name}</p>
                                                <p className="text-sm text-gray-600">{item.price.toLocaleString()}원</p>
                                            </div>
                                            <div className="flex items-center space-x-2">
                                                <button onClick={() => updateItemQuantity(item.id, item.quantity - 1)} className="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center font-bold">-</button>
                                                <span className="font-bold w-6 text-center">{item.quantity}</span>
                                                <button onClick={() => updateItemQuantity(item.id, item.quantity + 1)} className="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center font-bold">+</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p className="text-center text-gray-500 py-8">장바구니가 비어있습니다.</p>
                            )}
                            <div className="mt-6 pt-4 border-t border-gray-200 flex justify-between items-center">
                                <span className="text-xl font-bold text-gray-900">총: {totalPrice.toLocaleString()}원</span>
                                <button onClick={placeOrder} className={`bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-md font-bold transition ${totalItems === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-indigo-700'}`} disabled={totalItems === 0}>
                                    주문하기
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const totalItems = orderItems.reduce((acc, item) => acc + item.quantity, 0);
            const totalPrice = orderItems.reduce((acc, item) => acc + item.price * item.quantity, 0);
            
            return (
                <div className="bg-gray-100 font-sans min-h-screen">
                    <div className="container mx-auto p-4 sm:p-8 pb-32">
                        <header className="py-4 mb-4">
                            <h1 className="text-3xl font-bold text-center text-gray-800 no-select">CHAYA 메뉴판</h1>
                        </header>
                        
                        {isLoading ? (
                            <p className="text-center text-gray-500">메뉴를 불러오는 중...</p>
                        ) : (
                            Object.keys(menus).map(category => (
                                <div key={category} className="mb-8">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">{category}</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                        {menus[category].map(menu => (
                                            <div 
                                                key={menu.id} 
                                                onClick={() => handleMenuItemClick(menu)} 
                                                className="bg-white rounded-3xl shadow-lg p-4 cursor-pointer hover:shadow-xl transition-shadow duration-300"
                                            >
                                                <img src={menu.imageUrl} alt={menu.name} className="w-full h-40 object-cover rounded-2xl mb-4" />
                                                <div className="flex flex-col">
                                                    <h3 className="text-xl font-bold text-gray-800 truncate">{menu.name}</h3>
                                                    <p className="text-indigo-600 font-bold mt-1">{menu.price.toLocaleString()}원</p>
                                                    <p className="text-sm text-gray-500 mt-2 truncate">{menu.description}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {totalItems > 0 && (
                        <footer className="fixed bottom-0 left-0 w-full bg-white shadow-xl p-4 z-50">
                            <div className="container mx-auto max-w-5xl summary-flex">
                                <span className="text-xl font-bold text-gray-800 pr-4">총 {totalPrice.toLocaleString()}원 ({totalItems}개)</span>
                                <button onClick={() => setIsCartOpen(true)} className="bg-indigo-600 text-white p-3 rounded-lg shadow-md hover:bg-indigo-700 transition flex-shrink-0">
                                    주문 확인
                                </button>
                            </div>
                        </footer>
                    )}

                    {isItemModalOpen && <ItemDetailModal />}
                    {isCartOpen && <CartModal />}
                    
                    <div className={`message-box text-center bg-gray-900 text-white text-sm px-4 py-2 rounded-lg shadow-xl opacity-0 ${isMessageVisible ? 'show' : ''}`}>
                        {message}
                    </div>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
