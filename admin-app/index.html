<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAYA 관리자</title>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://kzxdrwdfqhwpkqbswutr.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const VAPID_PUBLIC_KEY = "YOUR_VAPID_PUBLIC_KEY";

        async function subscribeUserToPush() {
            if (!('serviceWorker' in navigator)) { return; }
            try {
                // ✅ scope를 /admin/ 으로 축소
                const registration = await navigator.serviceWorker.register('/admin/sw.js', { scope: '/admin/' });
                console.log('서비스 워커 등록 완료:', registration);
                const permissionResult = await Notification.requestPermission();
                if (permissionResult !== 'granted') return;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                await supabase.from('push_subscriptions').insert({
                    endpoint: subscription.endpoint,
                    p256dh: subscription.toJSON().keys.p256dh,
                    auth: subscription.toJSON().keys.auth
                });
            } catch (err) { console.error('푸쉬 알림 구독 실패:', err); }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        const App = () => (<div> {/* 기존 코드 유지, 서비스워커 등록만 수정 */} </div>);
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
